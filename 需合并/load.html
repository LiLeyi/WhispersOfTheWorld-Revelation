<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>读取/保存存档</title>
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/style.css">
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery-3.6.0.min.js"></script>

<style>
/* 顶部导航栏 */
.navbar-custom {
    background-color: #767676;
    color: white;
}
.navbar-custom a, .navbar-custom button {
    color: white;
    text-decoration: none;
    margin-left: 15px;
    border: none;
    background: none;
}
.navbar-custom a:hover, .navbar-custom button:hover {
    text-decoration: underline;
}

/* 容器居中 */
#saveSlotsContainer {
    margin-top: 50px;
}

/* 每行使用 flex 布局 */
.row {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

/* 存档槽样式 */
.save-slot {
    flex: 0 0 30%;
    margin: 1%;
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

/* 存档信息 */
.save-info h2 {
    margin-bottom: 5px;
}

/* 存档按钮 */
.save-buttons {
    display: flex;
    justify-content: center;
    margin-top: 10px;
}
.save-button {
    margin: 0 5px;
    cursor: pointer;
}
.save-button img.hover {
    display: none;
}
.save-button:hover img.normal {
    display: none;
}
.save-button:hover img.hover {
    display: inline-block;
}
</style>
</head>

<body class="bg">

<!-- 顶部导航栏 -->
<nav class="navbar navbar-custom">
    <a href="index.html">主菜单</a>
    <span style="margin-left:20px;">读取/保存存档</span>
    <button id="continueGame">继续游戏</button>
</nav>

<!-- 背景音乐 -->
<audio id="bgAudio" autoplay loop>
    <source src="#" type="audio/ogg">
</audio>

<!-- 悬停音效 -->
<audio id="hoverSound">
    <source src="#" type="audio/ogg">
</audio>

<!-- 点击音效 -->
<audio id="clickSound">
    <source src="#" type="audio/ogg">
</audio>

<div class="container" id="saveSlotsContainer"></div>

<script>
const STORAGE_KEY = "myGameSaveSlots";
let saveData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
while(saveData.length < 9) saveData.push(null);

// 获取打开 load 的来源页
const urlParams = new URLSearchParams(window.location.search);
const referrerPage = urlParams.get('referrer') || localStorage.getItem("lastGamePage") || "index.html";

// 渲染存档槽
function renderSlots(){
    const container = document.getElementById('saveSlotsContainer');
    container.innerHTML = '';

    for(let row=0; row<3; row++){
        const rowDiv = document.createElement('div');
        rowDiv.className = 'row';

        for(let col=0; col<3; col++){
            const index = row*3 + col;
            const slot = saveData[index];
            const div = document.createElement('div');
            div.className = 'save-slot';

            div.innerHTML = `
                <div class="save-info">
                    <h2>存档${index + 1}</h2>
                    <p>${slot ? slot.date : '空'}</p>
                    <p>${slot ? slot.chapter : ''}</p>
                </div>
                <div>
                    <img src="${slot ? ('../../images/background/' + slot.background) : './img/bgr/black.jpg'}" style="height:120px; width:auto;">
                </div>
                <div class="save-buttons">
                    <div class="save-button" onclick="loadGame(${index})">
                        <img class="normal" src="./img/load.png">
                        <img class="hover" src="./img/load_hover.png">
                    </div>
                    <div class="save-button" onclick="saveGame(${index})">
                        <img class="normal" src="./img/save.png">
                        <img class="hover" src="./img/save_hover.png">
                    </div>
                    <div class="save-button" onclick="deleteGame(${index})">
                        <img class="normal" src="./img/delete.png">
                        <img class="hover" src="./img/delete_hover.png">
                    </div>
                </div>
            `;
            rowDiv.appendChild(div);
        }
        container.appendChild(rowDiv);
    }

    const hoverSound = document.getElementById('hoverSound');
    document.querySelectorAll('.save-button').forEach(btn=>{
        btn.addEventListener('mouseover', ()=>hoverSound.play());
    });
}

// 加载存档
function loadGame(index){
    const slot = saveData[index];
    if(!slot){
        alert('该存档为空');
        return;
    }

    // 恢复用户状态
    if(slot.userFlags){
        localStorage.setItem("userArr", JSON.stringify(slot.userFlags));
    }
    localStorage.setItem("nowclick", slot.click);
    localStorage.setItem("MSYbackgroundIMG", slot.background);
    localStorage.setItem("MSYgamename", slot.chapter);

    document.getElementById('clickSound').play();

    // 跳转回存档页面
    const page = referrerPage || slot.page;
    window.location.href = page + "?click=" + slot.click;
}

// 保存存档
function saveGame(index){
    const now = new Date();
    const pagePath = localStorage.getItem("lastGamePage") || window.location.pathname; 
    const currentClick = parseInt(localStorage.getItem("nowclick")) || 0;
    const currentBackground = localStorage.getItem("MSYbackgroundIMG") || "none";
    const currentChapter = localStorage.getItem("MSYgamename") || "未知章节";
    const userFlags = JSON.parse(localStorage.getItem("userArr")) || null;

    saveData[index] = {
        date: now.toLocaleString(),
        page: pagePath,
        click: currentClick,
        background: currentBackground,
        chapter: currentChapter,
        userFlags: userFlags
    };

    localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
    renderSlots();
    document.getElementById('clickSound').play();
    alert(`已保存到存档${index+1}：章节 ${currentChapter}`);
}

// 删除存档
function deleteGame(index){
    if(confirm(`确定要删除存档${index+1}吗？`)){
        saveData[index] = null;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
        renderSlots();
        document.getElementById('clickSound').play();
        alert(`存档${index+1}已删除`);
    }
}

// “继续游戏”按钮
document.getElementById("continueGame").addEventListener("click", function() {
    const lastClick = parseInt(localStorage.getItem("nowclick")) || 0;
    window.location.href = referrerPage + "?click=" + lastClick;
});

// 渲染存档槽
renderSlots();
</script>
</body>
</html>
